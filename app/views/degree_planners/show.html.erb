<body class="degreeplan-body">
  <div class="profile-header">
    <%# 
      Header section with a link to return to the student dashboard, logo, and user avatar. 
      Includes a dropdown menu for profile actions (Profile, Settings, and Sign Out).
    %>
    <div class="profile-back-to-dashboard">
      <%= link_to student_dashboard_path(@student.google_id), class: 'profile-back-to-dashboard-link' do %>
        <span class="profile-back-arrow">&#8592;</span>
        Home
      <% end %>
    </div>

    <div class="profile-logo-container">
      <%= image_tag 'logo1.png', alt: 'Cleo Logo', class: 'profile-logo' %>
    </div>

    <div class="profile-user-info">
      <div class="profile-avatar-dropdown">
        <%# Display student's avatar, with a default fallback image. Clicking the avatar toggles the dropdown menu. %>
        <%= image_tag(current_student_login.avatar_url.present? ? current_student_login.avatar_url : 'default_avatar_url.jpg', alt: 'User Avatar', class: 'profile-avatar', id: 'avatar') %>

        <%# Dropdown menu for profile actions %>
        <div class="profile-dropdown-menu" id="dropdown-menu">
          <%= link_to "Profile", profile_student_path(current_student_login), class: 'profile-dropdown-link'%>
          <%= link_to 'Settings', '#', class: 'profile-dropdown-link' %>
          <%= link_to 'Sign Out', destroy_student_login_session_path, method: :delete, class: 'profile-dropdown-link' %>
        </div>
      </div>
    </div>
  </div>

  <%# Main heading for the degree planner page %>
  <h1 class="degreeplan-title">Your Degree Planner</h1>

  <%# 
    Form to add a new course to a specific semester.
    The form allows the user to select a course and specify which semester it should be added to.
  %>
  <%= form_with url: update_plan_student_degree_planner_path(@student), method: :patch, class: 'add-course-form' do |f| %>
    <h2>Add a Course</h2>
    <%= label_tag :add_course, "Course" %>
    <%= select_tag :add_course, options_from_collection_for_select(Course.all, :id, :cname) %>

    <%= label_tag :sem, "Semester" %>
    <%= number_field_tag :sem, nil, min: 1, max: 8 %>

    <%= f.submit "Add Course", class: 'add-course-button' %>
  <% end %>
  <br>

  <%# 
    Grid layout for displaying each semester.
    Each semester contains a table of courses that are already added to that semester.
  %>
  <div class="degreeplan2-grid">
    <% (1..8).each do |sem| %>
      <div class="semester2-container">
        <h3>Semester <%= sem %>:</h3>

        <%# Table listing the courses assigned to this semester %>
        <table>
          <thead>
            <tr>
              <th>Course Name</th>
              <th>Course CRN</th>
              <th>Credits</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="semester-<%= sem %>-courses">
            <% @student.student_courses.where(sem: sem).each do |student_course| %>
              <tr id="course-<%= student_course.course.id %>-semester-<%= sem %>">
                <td><%= student_course.course.cname %></td>
                <td><%= "#{student_course.course.ccode} #{student_course.course.cnumber}" %></td> 
                <td><%= student_course.course.credit_hours %></td>
                <td>
                  <%# Link to remove the course from the semester %>
                  <%= link_to 'Remove', remove_course_student_degree_planner_path(@student, course_id: student_course.course.id), 
                                method: :delete, 
                                data: { confirm: "Are you sure you want to remove this course?" }, 
                                class: 'remove-course-button' %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% end %>
  </div>

  <%# 
    Form to generate a degree planner based on the student's selected interests.
    Includes fields for track, emphasis area, and targeted graduation year.
  %>
  <h2 class="generate-form-title">Generate Based on Interests</h2>
  <%= form_with url: student_degree_planner_path(@student), method: :post, class: "generate-form" do |f| %>
    <div class="generate_form-group">
      <%= label_tag :track_id, "Track", class: "generate-label" %>
      <%= select_tag "interests[track_id]", options_from_collection_for_select(Track.all, :id, :tname), class: 'interest-select' %>
    </div>

    <div class="generate_form-group">
      <%= label_tag :emphasis_area, "Emphasis Area", class: "generate-label" %>
      <%= select_tag "interests[emphasis_area]", options_for_select([['Data Science', 'data_science'], ['Software Engineering', 'software_engineering'], ['Cybersecurity', 'cybersecurity']]), class: 'interest-select' %>
    </div>

    <div class="generate_form-group">
      <%= label_tag :target_graduation, "Targeted Graduation Year", class: "generate-label" %>
      <%= select_tag "interests[target_graduation]", options_for_select((2025..2035).to_a), class: 'interest-select' %>
    </div>

    <%= f.submit "Generate Planner", class: 'generate-planner-button' %>
  <% end %>
  <br>

  <%# 
    Action buttons for saving and downloading the degree plan.
    These forms allow the user to either save or download the current plan.
  %>
  <div class="action-buttons">
    <%= form_with url: download_plan_student_degree_planner_path(@student), method: :post do |f| %>
      <%= f.submit 'Save Degree Plan', class: 'action-button save-button' %>
      <%= f.submit 'Download Degree Plan', class: 'action-button download-button' %>
    <% end %>
  </div>

<script>
  <%# 
    JavaScript functionality to handle the removal of courses from a semester.
    Sends a DELETE request when the "Remove" link is clicked and reloads the page on success.
  %>
  document.querySelectorAll('.remove-course-button').forEach(function(link) {
      link.addEventListener('click', function(e) {
          e.preventDefault(); // Prevent the default anchor click behavior

          const courseId = e.currentTarget.getAttribute('data-course-id'); // Get the course ID

          if (confirm("Are you sure you want to remove this course?")) {
              // Make the DELETE request using Fetch API
              fetch(e.currentTarget.href, {
                  method: 'DELETE',
                  headers: {
                      'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
                  }
              })
              .then(response => {
                  if (response.redirected) {
                      window.location.href = response.url; // Handle redirect
                  } else if (response.ok) {
                      alert('Course removed successfully!');
                      window.location.href = `/students/${<%= @student.id %>}/degree_planner`; // Adjust the path if necessary
                  } else {
                      alert('Failed to remove the course.');
                  }
              })
              .catch(error => {
                  console.error('Error:', error);
                  alert('An error occurred while removing the course.');
              });
          }
      });
  });
</script>

<script>
  <%# 
    JavaScript to toggle the dropdown menu visibility when the user clicks on the avatar.
    Also hides the dropdown if the user clicks outside the menu.
  %>
  document.addEventListener('DOMContentLoaded', function() {
    const avatar = document.getElementById('avatar');
    const dropdownMenu = document.getElementById('dropdown-menu');

    // Toggle dropdown visibility
    avatar.addEventListener('click', function() {
      dropdownMenu.classList.toggle('profile-show');
    });

    // Hide dropdown if clicking outside
    document.addEventListener('click', function(event) {
      if (!avatar.contains(event.target) && !dropdownMenu.contains(event.target)) {
        dropdownMenu.classList.remove('profile-show');
      }
    });
  });
</script>
</body>
